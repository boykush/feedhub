#!/usr/bin/env bash
#MISE description="Deploy platform resources (ArgoCD, Istio) for local environment"

set -e

# Create namespaces
echo "Creating platform namespaces..."
kubectl apply -f k8s/base/platform/namespace.yaml

# Install ArgoCD if not already installed
if ! kubectl get deployment argocd-server -n argocd &>/dev/null; then
  echo "Installing ArgoCD..."
  kubectl apply -k k8s/base/platform/argocd

  echo "Waiting for ArgoCD to be ready..."
  kubectl wait --for=condition=available --timeout=300s deployment -n argocd argocd-server
else
  echo "ArgoCD already installed"
fi

# Deploy Istio via ArgoCD Applications
echo "Deploying Istio via ArgoCD..."
kubectl apply -k k8s/overlays/local/platform

echo "Waiting for Istio to be ready..."
kubectl wait --for=condition=available --timeout=300s deployment -n istio-system istiod || true

# Deploy CloudNativePG via ArgoCD Application
echo "Deploying CloudNativePG via ArgoCD..."
kubectl apply -f k8s/base/platform/cloudnative-pg/application.yaml

echo "Waiting for CloudNativePG operator to be ready..."
kubectl wait --for=condition=available --timeout=300s deployment -n cnpg-system cnpg-controller-manager || true

echo "Platform setup complete!"
