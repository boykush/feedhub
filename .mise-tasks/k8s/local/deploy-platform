#!/usr/bin/env bash
#MISE description="Deploy platform resources (ArgoCD, Istio) for local environment"

set -e

# Create namespaces (required before ArgoCD install)
echo "Creating platform namespaces..."
kubectl apply -f k8s/base/platform/namespace.yaml

# Install ArgoCD if not already installed
if ! kubectl get deployment argocd-server -n argocd &>/dev/null; then
  echo "Installing ArgoCD..."
  kubectl apply -k k8s/base/platform/argocd

  echo "Waiting for ArgoCD to be ready..."
  kubectl wait --for=condition=available --timeout=300s deployment -n argocd argocd-server
else
  echo "ArgoCD already installed"
fi

# Deploy platform Application CRs (ArgoCD handles the rest)
echo "Deploying platform applications via ArgoCD..."
kubectl apply -k k8s/overlays/local/platform

echo "Platform setup complete!"
